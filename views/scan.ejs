<!DOCTYPE html>
<html>
<head>
  <title>Lost & Found Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    video { width: 100%; max-width: 500px; border: 2px solid #444; margin-top: 10px; }
    #result { margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ccc; }
    #recent { margin-top: 20px; }
    button { margin-right: 10px; padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    select { font-size: 16px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Lost & Found Scanner</h1>

  <label for="actionSelect">Select Action Before Scanning:</label>
  <select id="actionSelect">
    <option value="lookup">Lookup</option>
    <option value="dashboard">Connect to Dashboard</option>
  </select>

  <br>
  <button id="startBtn">Start Camera</button>
  <button id="flipBtn">Flip Camera</button>

  <video id="video" autoplay muted></video>
  <div id="result">Scanned code will appear here</div>

  <h3>Recently Scanned Items:</h3>
  <ul id="recent"></ul>

  <!-- ZXing UMD library -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>

  <script>
    window.onload = () => {
      const startBtn = document.getElementById('startBtn');
      const flipBtn = document.getElementById('flipBtn');
      const video = document.getElementById('video');
      const resultDiv = document.getElementById('result');
      const recentList = document.getElementById('recent');
      const actionSelect = document.getElementById('actionSelect');

      if (!window.ZXing) {
        resultDiv.innerText = 'Error: ZXing library not loaded.';
        return;
      }

      const codeReader = new ZXing.BrowserMultiFormatReader();
      let lastCode = null;
      const recentlyScanned = [];
      let currentDeviceId = null;
      let devices = [];
      let facingMode = "environment"; // default back camera

      // List available cameras
      codeReader.listVideoInputDevices().then(videoInputDevices => {
        devices = videoInputDevices;
        if (devices.length === 0) resultDiv.innerText = 'No camera found';
      });

      // Start scanning
      startBtn.addEventListener('click', async () => {
        try {
          await startCamera();
          startBtn.disabled = true;
        } catch (err) {
          resultDiv.innerText = 'Camera access denied or unavailable';
          console.error(err);
        }
      });

      // Flip camera
      flipBtn.addEventListener('click', async () => {
        facingMode = (facingMode === "environment") ? "user" : "environment";
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
        await startCamera();
      });

      async function startCamera() {
        const constraints = { video: { facingMode: facingMode } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        // Pick a deviceId if needed
        if (devices.length > 0) currentDeviceId = devices[0].deviceId;

        codeReader.decodeFromVideoDevice(currentDeviceId, video, (result, err) => {
          if (result && result.getText() !== lastCode) {
            lastCode = result.getText();
            resultDiv.innerText = 'Scanned: ' + lastCode + ' (Action: ' + actionSelect.value + ')';

            // Add to recently scanned
            recentlyScanned.unshift(lastCode + ' (' + actionSelect.value + ')');
            if (recentlyScanned.length > 10) recentlyScanned.pop();

            recentList.innerHTML = '';
            recentlyScanned.forEach(code => {
              const li = document.createElement('li');
              li.textContent = code;
              recentList.appendChild(li);
            });

            // Handle action
            if (actionSelect.value === 'lookup') {
              console.log('Lookup code:', lastCode);
              // TODO: call lookup API
            } else if (actionSelect.value === 'dashboard') {
              console.log('Connect to dashboard with code:', lastCode);
              // TODO: send code to dashboard
            }
          }
        });
      }
    };
  </script>
</body>
</html>
