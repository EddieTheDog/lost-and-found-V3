<!DOCTYPE html>
<html>
<head>
  <title>Live Barcode Scan</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    video { border: 1px solid black; width: 400px; height: 300px; margin-top: 10px; }
    #result { margin-top: 20px; font-weight: bold; }
    #permission-message { color: red; font-weight: bold; margin-bottom: 10px; }
    #startBtn { padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Live Scan</h1>

  <div id="permission-message"></div>

  <label for="mode">Mode:</label>
  <select id="mode">
    <option value="lookup">Lookup Item</option>
    <option value="recent">Connect to Dashboard</option>
  </select>

  <p>Point your camera at a barcode or QR code, then click "Start Scanning"</p>
  <button id="startBtn">Start Scanning</button>

  <video id="video" autoplay></video>
  <div id="result"></div>

  <!-- ZXing UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/dist/index.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    const modeSelect = document.getElementById('mode');
    const permissionMessage = document.getElementById('permission-message');
    const startBtn = document.getElementById('startBtn');

    const codeReader = new ZXing.BrowserMultiFormatReader();
    let lastCode = null;

    startBtn.addEventListener('click', async () => {
      try {
        // Explicitly request camera access
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        video.play();

        const videoInputDevices = await codeReader.listVideoInputDevices();
        if(videoInputDevices.length === 0){
          permissionMessage.innerText = 'No camera found on this device.';
          return;
        }
        const firstDeviceId = videoInputDevices[0].deviceId;

        // Start live scanning
        codeReader.decodeFromVideoDevice(firstDeviceId, video, async (result, err) => {
          if(result){
            const code = result.getText();
            if(code === lastCode) return; // prevent duplicate scans
            lastCode = code;

            const mode = modeSelect.value;

            try {
              const res = await fetch('/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, mode })
              });
              const data = await res.json();
              if(data.success){
                resultDiv.innerHTML = `✅ Scanned: ${data.item.name} - ${data.item.description} - Status: ${data.item.status} - Location: ${data.item.location}`;
              } else {
                resultDiv.innerHTML = `❌ Error: ${data.message}`;
              }
            } catch(e){
              resultDiv.innerHTML = '❌ Network error';
            }

          } else if(err && !(err instanceof ZXing.NotFoundException)){
            console.error(err);
          }
        });

        startBtn.disabled = true; // prevent multiple clicks
      } catch(err) {
        permissionMessage.innerText = 'Camera access denied or not available. Please allow camera access.';
        console.error(err);
      }
    });
  </script>
</body>
</html>
