<video id="video" autoplay muted></video>
<button id="startBtn">Start Scan</button>
<div id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/dist/index.min.js"></script>
<script>
  window.onload = () => {
    const startBtn = document.getElementById('startBtn');
    const video = document.getElementById('video');
    const resultDiv = document.getElementById('result');

    if (!window.ZXing) {
      resultDiv.innerText = 'Error: ZXing library not loaded.';
      return;
    }

    const codeReader = new ZXing.BrowserMultiFormatReader();
    let lastCode = null;

    startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;

        const devices = await codeReader.listVideoInputDevices();
        if (devices.length === 0) {
          resultDiv.innerText = 'No camera found';
          return;
        }

        const deviceId = devices[0].deviceId;
        codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
          if (result && result.getText() !== lastCode) {
            lastCode = result.getText();
            resultDiv.innerText = 'Scanned: ' + lastCode;
          }
        });

        startBtn.disabled = true;
      } catch (err) {
        resultDiv.innerText = 'Camera access denied or unavailable';
        console.error(err);
      }
    });
  }
</script>
